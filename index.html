<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js ì ì‘í˜• ìˆ˜í•™ íŠœí„° (Gemini API)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- KaTeX CDN (ìˆ˜í•™ ê³µì‹ ë Œë”ë§) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" xintegrity="sha384-sM5DpostPRinVMVMyOTTsDhpBYPbCgBqG/IPhA+M+AVeEGLuL/fLImgO+kBCXmL5" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" xintegrity="sha384-hIoIeSUdaeBIfIPph+VbHnIaMVC4UaCDB/P+6iAoI2H+RmsjAFzQuEEVs4jGnmTM" crossorigin="anonymous"></script>
    <!-- KaTeX Auto-render Axtension -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" xintegrity="sha384-4trT/hBKaI8D8sXGyOTrH/M/22jKx/A/bVDirI3/jnoHWdAGQCBvNfHlM+yLIndr" crossorigin="anonymous"></script>
    <!-- [NEW] Marked.js CDN (Markdown to HTML) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js"></script>

    <style>
        /* ê¸°ë³¸ Inter í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* KaTeX í°íŠ¸ í¬ê¸° ì¡°ì • */
        .katex {
            font-size: 1.1em;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* API í‚¤ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 500px;
            width: 90%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center p-4 font-inter">

    <div id="app" class="w-full max-w-3xl bg-white shadow-2xl rounded-2xl p-6 md:p-10 transition-all duration-500">
        
        <!-- [NEW] API í‚¤ ì…ë ¥ ëª¨ë‹¬ -->
        <div v-if="showApiKeyModal" class="modal-overlay">
            <div class="modal-content shadow-xl">
                <h2 class="text-2xl font-bold mb-4">Gemini API í‚¤ ì…ë ¥</h2>
                <p class="text-gray-600 mb-6">APIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. í‚¤ëŠ” ë¸Œë¼ìš°ì € ì¿ í‚¤ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                <input 
                    type="password" 
                    v-model="apiKeyInput"
                    @keyup.enter="saveApiKey"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                    placeholder="ã“ã“ã«APIã‚­ãƒ¼ã‚’å…¥åŠ›...">
                <div class="mt-6 flex justify-end space-x-4">
                    <button @click="saveApiKey" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 font-semibold">ì €ì¥</button>
                </div>
            </div>
        </div>

        <!-- ë¡œë”© í™”ë©´ -->
        <div v-if="isLoading" class="flex flex-col items-center justify-center min-h-[300px]">
            <div class="loader"></div>
            <p class="mt-4 text-lg text-gray-600">ë¬¸ì œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- í•™ìŠµ ì™„ë£Œ í™”ë©´ -->
        <div v-else-if="appState === 'finished'" class="text-center min-h-[300px] flex flex-col justify-center">
            <h2 class="text-3xl font-bold text-blue-600 mb-4">í•™ìŠµ ì™„ë£Œ!</h2>
            <p class="text-xl text-gray-700">ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤. ëŒ€ë‹¨í•´ìš”!</p>
            <p class="mt-2 text-lg">ìµœì¢… ë ˆë²¨: <span class="font-bold text-blue-500">{{ currentLevel.toFixed(1) }}</span></p>
            <button @click="loadProblems" class="mt-8 inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 font-semibold">
                ë‹¤ì‹œ í’€ê¸°
            </button>
        </div>

        <!-- íŠœí„° ë©”ì¸ í™”ë©´ -->
        <main v-else-if="currentProblem" :key="currentProblem.id" class="transition-all duration-300">
            <!-- 1. í•™ìŠµ ì§„í–‰ë¥  -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-blue-700">ì§„í–‰ë¥  ({{ answeredProblems.size }} / {{ allProblems.length }})</span>
                    <span class="text-sm font-medium text-gray-600">í˜„ì¬ ë ˆë²¨: <span class="font-bold text-blue-600">{{ currentLevel.toFixed(1) }}</span></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" :style="{ width: progressPercentage + '%' }"></div>
                </div>
            </div>

            <!-- 2. ë¬¸ì œ ì„¹ì…˜ -->
            <div class="border border-gray-200 rounded-lg p-5 mb-6 shadow-sm bg-gray-50">
                <div class="flex justify-between items-center mb-4">
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full">{{ currentProblem.category }}</span>
                    <span class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-semibold rounded-full">ë‚œì´ë„: {{ currentProblem.difficulty }}</span>
                </div>
                <h2 class="text-2xl font-semibold mb-4 text-gray-900">ë¬¸ì œ #{{ currentProblem.id }}</h2>
                <!-- KaTeXê°€ ë Œë”ë§í•  ì»¨í…ì¸  -->
                <div id="question-content" class="text-lg leading-relaxed space-y-2" v-html="currentProblem.question"></div>
            </div>

            <!-- 3. ë‹µë³€ ì…ë ¥ ì„¹ì…˜ -->
            <div class="mb-6">
                <label for="answer" class="block text-lg font-semibold mb-3 text-gray-700">ì—¬ëŸ¬ë¶„ì˜ ë‹µ:</label>
                <input 
                    type="text" 
                    id="answer" 
                    v-model="userAnswer" 
                    @keyup.enter="submitAnswer"
                    :disabled="appState !== 'solving'"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                    placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”...">
            </div>

            <!-- 4. í”¼ë“œë°± ë° ë²„íŠ¼ -->
            <div class="min-h-[50px] mb-6">
                <!-- í”¼ë“œë°± ë©”ì‹œì§€ -->
                <p v-if="feedback" 
                   :class="isCorrect ? 'text-green-600' : 'text-red-600'" 
                   class="text-lg font-semibold text-center p-3 rounded-lg"
                   v-html="feedback">
                </p>
            </div>

            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- ë¬¸ì œ í’€ì´ ì¤‘ ë²„íŠ¼ -->
                <template v-if="appState === 'solving'">
                    <button @click="submitAnswer" class="w-full px-6 py-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 font-bold text-lg">
                        ì œì¶œí•˜ê¸°
                    </button>
                    <button @click="requestAiHint" :disabled="isAiLoading" class="w-full px-6 py-4 bg-gray-700 text-white rounded-lg shadow-md hover:bg-gray-800 transition-all duration-300 font-bold text-lg flex items-center justify-center">
                        <svg v-if="isAiLoading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        {{ isAiLoading ? 'íŒíŠ¸ ìƒì„± ì¤‘...' : 'âœ¨ AI íŒíŠ¸ ìš”ì²­' }}
                    </button>
                </template>

                <!-- ì •ë‹µ/ì˜¤ë‹µ í›„ ë²„íŠ¼ -->
                <template v-if="appState === 'answered'">
                    <button @click="selectNextProblem" class="w-full px-6 py-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 font-bold text-lg">
                        ë‹¤ìŒ ë¬¸ì œ
                    </button>
                    <!-- [MODIFIED] 'í•´ì„¤ ë³´ê¸°' ë²„íŠ¼ì„ 'AI í•´ì„¤ ë³´ê¸°'ë¡œ ë³€ê²½ -->
                    <button @click="requestAiExplanation" :disabled="isAiLoading" class="w-full px-6 py-4 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 font-bold text-lg flex items-center justify-center">
                        <svg vif="isAiLoading && !aiExplanation" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        {{ (isAiLoading && !aiExplanation) ? 'í•´ì„¤ ìƒì„± ì¤‘...' : 'âœ¨ AI í•´ì„¤ ë³´ê¸°' }}
                    </button>
                </template>
            </div>

            <!-- 5. íŒíŠ¸ ë° í•´ì„¤ ì„¹ì…˜ -->
            <!-- AI íŒíŠ¸ (AIê°€ ìƒì„±) -->
            <div v-if="aiHint" class="mt-6 p-5 border border-purple-200 bg-purple-50 rounded-lg shadow-sm">
                <h3 class="text-lg font-bold text-purple-700 mb-3">âœ¨ AI íŒíŠ¸</h3>
                <div id="hint-content" class="text-gray-800 space-y-2" v-html="aiHint"></div>
            </div>
            
            <!-- [REMOVED] ì •ì  í•´ì„¤ (ë°ì´í„°ì—ì„œ ë¡œë“œ) -->
            <!-- <div v-if="showExplanationContent" ... > ... </div> -->
                
            <!-- [MODIFIED] AI ì¶”ê°€ í•´ì„¤ -> AI í•´ì„¤ (AIê°€ ìƒì„±) -->
            <div v-if="aiExplanation" class="mt-6 p-5 border border-green-200 bg-green-50 rounded-lg shadow-sm">
                <h3 class="text-lg font-bold text-green-700 mb-3">âœ¨ AI í•´ì„¤</h3>
                <div id="ai-explanation-content" class="text-gray-800 space-y-2" v-html="aiExplanation"></div>
            </div>
        </main>

        <!-- [NEW] API í‚¤ ê´€ë¦¬ ë²„íŠ¼ -->
        <div class="mt-8 text-center">
            <button @click="clearApiKey" class="text-sm text-gray-500 hover:text-gray-700 hover:underline">API í‚¤ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <script type="module">
        // Vue 3 Composition API ì‚¬ìš©
        const { createApp, ref, onMounted, computed, nextTick, watch } = Vue;

        // [MODIFIED]: í•˜ë“œì½”ë”©ëœ problemsData ë°°ì—´ì„ ì‚­ì œí•©ë‹ˆë‹¤.
        // const problemsData = [...];

        createApp({
            setup() {
                // --- ìƒíƒœ (Reactivity) ---
                const allProblems = ref([]); // ì „ì²´ ë¬¸ì œ ì€í–‰
                const isLoading = ref(true); // ë°ì´í„° ë¡œë”© ì—¬ë¶€
                const currentProblem = ref(null); // í˜„ì¬ ë¬¸ì œ ê°ì²´
                const userAnswer = ref(''); // ì‚¬ìš©ì ì…ë ¥ ë‹µ
                const feedback = ref(''); // ì •ë‹µ/ì˜¤ë‹µ í”¼ë“œë°±
                const isCorrect = ref(false); // ì •ë‹µ ì—¬ë¶€
                const appState = ref('solving'); // ì•± ìƒíƒœ (solving, answered, finished)
                const currentLevel = ref(3.0); // í•™ìƒì˜ í˜„ì¬ ë ˆë²¨ (1~5)
                const answeredProblems = ref(new Set()); // í‘¼ ë¬¸ì œ ID Set
                
                // [NEW] API í‚¤ ê´€ë ¨ ìƒíƒœ
                const showApiKeyModal = ref(false);
                const apiKeyInput = ref('');

                // AI ê´€ë ¨ ìƒíƒœ
                const isAiLoading = ref(false); // AI ì‘ë‹µ ë¡œë”© ì—¬
                const aiHint = ref(''); // [FIXED] AI ìƒì„± íŒíŠ¸ ë³€ìˆ˜ ì •ì˜ ì¶”ê°€
                const aiExplanation = ref(''); // AI ìƒì„± ì¶”ê°€ í•´ì„¤

                // --- ê³„ì‚°ëœ ì†ì„± (Computed) ---
                const progressPercentage = computed(() => {
                    if (allProblems.value.length === 0) return 0;
                    return (answeredProblems.value.size / allProblems.value.length) * 100;
                });

                // --- [NEW] ì¿ í‚¤ í—¬í¼ í•¨ìˆ˜ ---
                const setCookie = (name, value, days) => {
                    let expires = "";
                    if (days) {
                        const date = new Date();
                        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                        expires = "; expires=" + date.toUTCString();
                    }
                    document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax; Secure";
                };

                const getCookie = (name) => {
                    const nameEQ = name + "=";
                    const ca = document.cookie.split(';');
                    for(let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                };

                const eraseCookie = (name) => {
                    document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                };


                // --- Gemini API í˜¸ì¶œ ë¡œì§ ---
                const callGeminiAPI = async (userPrompt, systemPrompt, retries = 3, delay = 1000) => {
                    isAiLoading.value = true;
                    
                    // [MODIFIED] ì¿ í‚¤ì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
                    const apiKey = getCookie("geminiApiKey");
                    
                    // [MODIFIED] API í‚¤ê°€ ì—†ìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ
                    if (!apiKey) {
                        showApiKeyModal.value = true;
                        isAiLoading.value = false;
                        feedback.value = "Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.";
                        return "API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                    }

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

                    const payload = {
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: {
                            parts: [{ text: systemPrompt }]
                        },
                    };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 400) { // 400 Bad Request (ì˜ëª»ëœ API í‚¤ ë“±)
                                eraseCookie("geminiApiKey"); // ì˜ëª»ëœ í‚¤ ì‚­ì œ
                                showApiKeyModal.value = true;
                                feedback.value = "ì˜ëª»ëœ API í‚¤ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                                return "ì˜ëª»ëœ API í‚¤";
                            }
                            if (response.status === 429 && retries > 0) { // 429: Too Many Requests
                                console.warn(`API rate limit. Retrying in ${delay / 1000}s... (${retries} retries left)`);
                                await new Promise(res => setTimeout(res, delay));
                                return callGeminiAPI(userPrompt, systemPrompt, retries - 1, delay * 2); // Exponential backoff
                            }
                            throw new Error(`API Error: ${response.statusText} (Status: ${response.status})`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            // [MODIFIED] API ì‘ë‹µ êµ¬ì¡° ì˜¤ë¥˜ì— ëŒ€í•œ êµ¬ì²´ì ì¸ í”¼ë“œë°±
                            console.error("Unexpected API response structure:", result);
                            if (result.error) {
                                return `API ì˜¤ë¥˜: ${result.error.message}`;
                            }
                            throw new Error("APIë¡œë¶€í„° ìœ íš¨í•œ í…ìŠ¤íŠ¸ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                        }
                    } catch (error) {
                        console.error("Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
                        return "AI ì‘ë‹µì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë˜ëŠ” API í‚¤ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                    } finally {
                        isAiLoading.value = false;
                    }
                };

                // --- ë©”ì„œë“œ (Methods) ---

                // [NEW] API í‚¤ ì €ì¥
                const saveApiKey = () => {
                    if (apiKeyInput.value.trim()) {
                        setCookie("geminiApiKey", apiKeyInput.value.trim(), 30); // 30ì¼ê°„ ì €ì¥
                        showApiKeyModal.value = false;
                        apiKeyInput.value = '';
                        feedback.value = "API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    } else {
                        feedback.value = "API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                    }
                };

                // [NEW] API í‚¤ ì‚­ì œ
                const clearApiKey = () => {
                    eraseCookie("geminiApiKey");
                    showApiKeyModal.value = true;
                    feedback.value = "API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                };

                // KaTeX ìˆ˜í•™ ê³µì‹ ë Œë”ë§ í•¨ìˆ˜
                const renderMathematics = () => {
                    // nextTickì„ ì‚¬ìš©í•´ DOM ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œëœ í›„ KaTeX ë Œë”ë§
                    nextTick(() => {
                        try {
                            // ë Œë”ë§ì´ í•„ìš”í•œ ëª¨ë“  ì»¨í…ì¸  ì˜ì—­
                            // [MODIFIED] #explanation-content ì œê±°
                            const idsToRender = ['#question-content', '#hint-content', '#ai-explanation-content'];
                            idsToRender.forEach(id => {
                                const el = document.querySelector(id);
                                if (el) {
                                    renderMathInElement(el, {
                                        delimiters: [
                                            { left: '$$', right: '$$', display: true },
                                            { left: '\\[', right: '\\]', display: true },
                                            { left: '$', right: '$', display: false },
                                            { left: '\\(', right: '\\)', display: false }
                                        ],
                                        throwOnError: false
                                    });
                                }
                            });
                        } catch (error) {
                            console.error("KaTeX ë Œë”ë§ ì˜¤ë¥˜:", error);
                        }
                    });
                };
                
                // [MODIFIED] 1. ë¬¸ì œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                // fetchë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€ URLì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                const loadProblems = async () => {
                    isLoading.value = true;
                    // ì•± ìƒíƒœ ì´ˆê¸°í™” (ë‹¤ì‹œ í’€ê¸° ì‹œ)
                    answeredProblems.value.clear();
                    currentLevel.value = 3.0;
                    
                    try {
                        // [MODIFIED] ì‚¬ìš©ìê°€ ì œê³µí•œ ìƒˆ URLë¡œ fetch ìš”ì²­
                        const response = await fetch("https://raw.githubusercontent.com/corecreaters/laughing-octo-rotary-phone/refs/heads/main/problem2.json");
                        
                        if (!response.ok) {
                            // JSON íŒŒì‹± ì˜¤ë¥˜ëŠ” ì—¬ê¸°ì„œ ì¡íˆì§€ ì•Šê³ , .json()ì—ì„œ ì¡í˜
                            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë§Œ ì—¬ê¸°ì„œ ì¡í˜
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json(); // ì—¬ê¸°ì„œ JSON íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥
                        allProblems.value = data;
                        
                        if (allProblems.value.length > 0) {
                            selectNextProblem();
                        } else {
                            appState.value = 'finished'; // í’€ ë¬¸ì œê°€ ì—†ìŒ
                        }
                    } catch (error) {
                        console.error("ë¬¸ì œ ë¡œë”© ì‹¤íŒ¨:", error); // ì½˜ì†”ì— ìì„¸í•œ ì˜¤ë¥˜ ì¶œë ¥
                        // ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” í”¼ë“œë°±
                        feedback.value = `ë¬¸ì œ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜: ${error.message})`;
                    } finally {
                        isLoading.value = false;
                    }
                };

                // 2. ë‹¤ìŒ ë¬¸ì œ ì„ íƒ (í•µì‹¬ ë¡œì§)
                // [MODIFIED] ì•Œê³ ë¦¬ì¦˜ ìˆ˜ì •:
                // í˜„ì¬ ë ˆë²¨(currentLevel)ê³¼ ë‚œì´ë„(difficulty)ì˜ ì°¨ì´ê°€
                // ê°€ì¥ ì ì€ ë¬¸ì œë¥¼ ì„ íƒí•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
                const selectNextProblem = () => {
                    // í’€ì§€ ì•Šì€ ë¬¸ì œ í•„í„°ë§
                    const unsolvedProblems = allProblems.value.filter(
                        p => !answeredProblems.value.has(p.id)
                    );

                    if (unsolvedProblems.length === 0) {
                        appState.value = 'finished'; // ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’‚
                        currentProblem.value = null;
                        return;
                    }

                    // [NEW LOGIC]
                    // í’€ì§€ ì•Šì€ ë¬¸ì œë“¤ì„ (í˜„ì¬ ë ˆë²¨ - ë¬¸ì œ ë‚œì´ë„)ì˜ ì ˆëŒ€ê°’ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬í•©ë‹ˆë‹¤.
                    const sortedProblems = unsolvedProblems.sort((a, b) => {
                        const diffA = Math.abs(a.difficulty - currentLevel.value);
                        const diffB = Math.abs(b.difficulty - currentLevel.value);
                        return diffA - diffB;
                    });
                    
                    // ì •ë ¬ëœ ëª©ë¡ì˜ ì²« ë²ˆì§¸ ë¬¸ì œ (ê°€ì¥ ê·¼ì ‘í•œ ë¬¸ì œ)ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
                    const nextProblem = sortedProblems[0];

                    currentProblem.value = nextProblem;
                    if (!answeredProblems.value.has(nextProblem.id)) {
                        // ì´ ë¬¸ì œëŠ” ì´ì œ ë§‰ í’€ê¸° ì‹œì‘í•¨
                    }
                    resetProblemState();
                };

                // 3. ë¬¸ì œ ìƒíƒœ ì´ˆê¸°í™”
                const resetProblemState = () => {
                    appState.value = 'solving';
                    userAnswer.value = '';
                    feedback.value = '';
                    isCorrect.value = false;
                    // [REMOVED]
                    // showExplanationContent.value = false;
                    aiHint.value = ''; // AI ìƒíƒœ ì´ˆê¸°í™”
                    aiExplanation.value = ''; // AI ìƒíƒœ ì´ˆê¸°í™”
                };

                // 4. ë‹µë³€ ì œì¶œ
                const submitAnswer = () => {
                    if (!userAnswer.value.trim()) {
                        feedback.value = "ë‹µì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                        isCorrect.value = false;
                        return;
                    }
                    
                    // ê°„ë‹¨í•œ ì •ë‹µ ë¹„êµ (ê³µë°± ì œê±°, ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                    // (ì •ë‹µ í¬ë§·ì´ 'x > 3' ê°™ì´ ë‹¤ì–‘í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ ë¹„êµ í•„ìš”)
                    const processedAnswer = String(currentProblem.value.answer).trim().toLowerCase();
                    const processedUserAnswer = userAnswer.value.trim().toLowerCase();

                    if (processedUserAnswer === processedAnswer) {
                        feedback.value = "ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰";
                        isCorrect.value = true;
                        appState.value = 'answered';
                        answeredProblems.value.add(currentProblem.value.id);
                        // ë ˆë²¨ ì¡°ì • (ë§ì¶¤)
                        currentLevel.value = Math.min(5, currentLevel.value + 0.2); // ë ˆë²¨ ìƒìŠ¹
                    } else {
                        feedback.value = "í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ ë³´ì„¸ìš”. ğŸ˜¥";
                        isCorrect.value = false;
                        // ë ˆë²¨ ì¡°ì • (í‹€ë¦¼)
                        currentLevel.value = Math.max(1, currentLevel.value - 0.2); // ë ˆë²¨ í•˜ë½
                    }
                };

                // 5. AI íŒíŠ¸ ìš”ì²­
                const requestAiHint = async () => {
                    if (isAiLoading.value) return;
                    
                    // [MODIFIED] AIê°€ HTMLì´ ì•„ë‹Œ Markdown í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ë„ë¡ systemPrompt ìˆ˜ì •
                    const systemPrompt = "ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ ìˆ˜í•™ íŠœí„°ì…ë‹ˆë‹¤. í•™ìƒì´ ë¬¸ì œë¥¼ í’€ ìˆ˜ ìˆë„ë¡ ê²°ì •ì ì¸ íŒíŠ¸ê°€ ì•„ë‹Œ, ìƒê°ì˜ ë°©í–¥ì„ ì´ëŒì–´ì£¼ëŠ” ì§§ì€ íŒíŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ì œê³µí•´ ì£¼ì„¸ìš”. ì‘ë‹µì€ **Markdown í˜•ì‹**ìœ¼ë¡œ í¬ë§·íŒ…í•´ì£¼ì„¸ìš” (ì˜ˆ: ì¤„ë°”ê¿ˆ, ê¸€ë¨¸ë¦¬ ê¸°í˜¸, **ë³¼ë“œ** ë“± ì‚¬ìš©). ìˆ˜í•™ ê³µì‹ì€ KaTeX í˜•ì‹($$...$$ ë˜ëŠ” $...$)ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.";
                    
                    // [MODIFIED] userPromptì—ì„œ hints ì°¸ì¡° ì œê±°
                    const userPrompt = `
                        ë‹¤ìŒ ìˆ˜í•™ ë¬¸ì œì— ëŒ€í•œ íŒíŠ¸ë¥¼ ì£¼ì„¸ìš”:
                        ë¬¸ì œ: ${currentProblem.value.question}
                        
                        íŒíŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
                    `;
                    // [MODIFIED] AIì˜ Markdown ì‘ë‹µì„ HTMLë¡œ íŒŒì‹±
                    const rawMarkdown = await callGeminiAPI(userPrompt, systemPrompt);
                    if (rawMarkdown !== "API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤." && rawMarkdown !== "ì˜ëª»ëœ API í‚¤") {
                        aiHint.value = marked.parse(rawMarkdown || "");
                    }
                    
                    aiExplanation.value = ''; // ë‹¤ë¥¸ ì„¹ì…˜ ì´ˆê¸°í™”
                    // [REMOVED]
                    // showExplanationContent.value = false; // ë‹¤ë¥¸ ì„¹ì…˜ ì´ˆê¸°í™”
                };

                // [REMOVED]
                // 6. í•´ì„¤ ìš”ì²­ (ì •ì )
                // const showExplanation = () => { ... };

                // [MODIFIED] 7. AI (ì¶”ê°€) í•´ì„¤ ìš”ì²­ -> AI í•´ì„¤ ìš”ì²­
                const requestAiExplanation = async () => {
                    if (isAiLoading.value) return;
                    aiHint.value = ''; // íŒíŠ¸ê°€ ìˆë‹¤ë©´ ìˆ¨ê¹€

                    // [MODIFIED] 'ë‹¤ë¥¸ í’€ì´'ê°€ ì•„ë‹Œ 'ìì„¸í•œ í•´ì„¤'ì„ ìš”ì²­ + Markdown í˜•ì‹ ì‘ë‹µ ìš”ì²­
                    const systemPrompt = "ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ ìˆ˜í•™ íŠœí„°ì…ë‹ˆë‹¤. í•™ìƒì—ê²Œ ë¬¸ì œì˜ í•´ì„¤ì„ ë‹¨ê³„ë³„ë¡œ, ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”. í•œêµ­ì–´ë¡œ ì„¤ëª…í•˜ê³ , ì‘ë‹µì€ **Markdown í˜•ì‹**ìœ¼ë¡œ í¬ë§·íŒ…í•´ì£¼ì„¸ìš” (ì˜ˆ: ì¤„ë°”ê¿ˆ, ê¸€ë¨¸ë¦¬ ê¸°í˜¸, **ë³¼ë“œ** ë“± ì‚¬ìš©). ìˆ˜í•™ ê³µì‹ì€ KaTeX í˜•ì‹($$...$$ ë˜ëŠ” $...$)ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.";
                    const userPrompt = `
                        ë‹¤ìŒ ìˆ˜í•™ ë¬¸ì œì— ëŒ€í•œ 'ìì„¸í•œ í•´ì„¤'ì„ ì œê³µí•´ì£¼ì„¸ìš”.
                        ë¬¸ì œ: ${currentProblem.value.question}
                        
                        í•´ì„¤ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
                    `;
                    // [MODIFIED] AIì˜ Markdown ì‘ë‹µì„ HTMLë¡œ íŒŒì‹±
                    const rawMarkdown = await callGeminiAPI(userPrompt, systemPrompt);
                     if (rawMarkdown !== "API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤." && rawMarkdown !== "ì˜ëª»ëœ API í‚¤") {
                        aiExplanation.value = marked.parse(rawMarkdown || "");
                    }
                };

                // --- ìƒëª…ì£¼ê¸° (Lifecycle) ---
                onMounted(() => {
                    // [MODIFIED] ì•± ì‹œì‘ ì‹œ API í‚¤ í™•ì¸
                    if (!getCookie("geminiApiKey")) {
                        showApiKeyModal.value = true;
                    }

                    // KaTeXê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                    const checkKatex = () => {
                        if (window.renderMathInElement) {
                            loadProblems(); // KaTeX ì¤€ë¹„ ì™„ë£Œ í›„ ë¬¸ì œ ë¡œë“œ
                        } else {
                            setTimeout(checkKatex, 100); // 0.1ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸
                        }
                    };
                    checkKatex();
                });

                // --- ê°ì‹œì (Watchers) ---
                // AI íŒíŠ¸, í•´ì„¤, ë¬¸ì œê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ KaTeXë¥¼ ë‹¤ì‹œ ë Œë”ë§
                // [MODIFIED] showExplanationContent ì œê±°
                watch([currentProblem, aiHint, aiExplanation], () => {
                    renderMathematics();
                }, {
                    deep: true // ê°ì²´ ë‚´ë¶€ ë³€ê²½ ê°ì§€
                });

                // --- ë°˜í™˜ (Return) ---
                return {
                    // ìƒíƒœ
                    isLoading,
                    appState,
                    currentProblem,
                    userAnswer,
                    feedback,
                    isCorrect,
                    currentLevel,
                    answeredProblems,
                    allProblems,
                    showApiKeyModal,
                    apiKeyInput,
                    isAiLoading,
                    aiHint,
                    aiExplanation,
                    
                    // ê³„ì‚°ëœ ì†ì„±
                    progressPercentage,

                    // ë©”ì„œë“œ
                    loadProblems,
                    selectNextProblem,
                    submitAnswer,
                    requestAiHint,
                    requestAiExplanation,
                    saveApiKey,
                    clearApiKey
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
